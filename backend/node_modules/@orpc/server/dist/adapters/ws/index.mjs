import { readAsBuffer, resolveMaybeOptionalOptions } from '@orpc/shared';
import { ServerPeer } from '@orpc/standard-server-peer';
import { c as createServerPeerHandleRequestFn } from '../../shared/server.UVMTOWrk.mjs';
import '@orpc/client';
import '@orpc/standard-server';
import '@orpc/contract';
import { b as StandardRPCHandler } from '../../shared/server.Bxx6tqNe.mjs';
import '@orpc/client/standard';
import '../../shared/server.DZ5BIITo.mjs';
import '../../shared/server.Ds4HPpvH.mjs';

class WsHandler {
  constructor(standardHandler) {
    this.standardHandler = standardHandler;
  }
  async upgrade(ws, ...rest) {
    const peer = new ServerPeer(ws.send.bind(ws));
    ws.addEventListener("message", async (event) => {
      const message = Array.isArray(event.data) ? await readAsBuffer(new Blob(event.data)) : event.data;
      await peer.message(
        message,
        createServerPeerHandleRequestFn(this.standardHandler, resolveMaybeOptionalOptions(rest))
      );
    });
    ws.addEventListener("close", () => {
      peer.close();
    });
  }
}

class RPCHandler extends WsHandler {
  constructor(router, options = {}) {
    super(new StandardRPCHandler(router, options));
  }
}

export { RPCHandler, WsHandler };
